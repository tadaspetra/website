---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { Sources } from "../../components/Sources.tsx";

export async function getStaticPaths() {
  const posts = await getCollection("posts", ({ data }) => !data.draft);

  return posts.map((post) => {
    // Handle both flat files (2024/post-name.md) and folder-based (essays/how-computers-work/index.mdx)
    const parts = post.id.split("/");
    const filename = parts.pop() ?? "";
    // Remove .md or .mdx extension
    const basename = filename.replace(/\.mdx?$/, "");
    // If basename is "index", use the parent folder name as slug
    const slug = basename === "index" ? parts.pop() ?? post.id : basename;
    return {
      params: { slug },
      props: { post, slug },
    };
  });
}

const { post, slug } = Astro.props;
const { Content } = await post.render();

// OG image URL for this post
const ogImage = `/${slug}/index.png`;
---

<Layout
  title={post.data.title}
  description={post.data.description}
  ogImage={ogImage}
>
  <main class="max-w-2xl mx-auto px-4 sm:px-6 py-12 sm:py-16 md:py-24">
    <article class="prose dark:prose-invert prose-neutral max-w-none">
      <h2 class="mb-0">{post.data.title}</h2>
      <p class="text-neutral-500 dark:text-neutral-400 -mt-2 pt-0 mb-8">
        By Tadas Petra
      </p>
      {post.data.sources && <Sources sources={post.data.sources} client:load />}
      <Content />
    </article>
  </main>
</Layout>
